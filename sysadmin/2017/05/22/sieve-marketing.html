<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Removing marketing links in e-mails with Sieve</title>
  <meta name="description" content="Using Sieve and python, this script removes marketing links from e-mails to always hover at the exact link you will be redirected to.">
  <meta name="keywords" content="blog, Mathieu Rousse, linux, pentest, challenge, ctf, writeup">
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,300,500,600&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/main.min.css">
  <link rel="canonical" href="https://math.rousse.me/sysadmin/2017/05/22/sieve-marketing.html">
  <link rel="alternate" type="application/rss+xml" title="Last code until midnight" href="https://math.rousse.me/feed.xml">
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "Mathieu Rousse",
    "url": "https://math.rousse.me",
    "sameAs": [
      "https://fr.linkedin.com/in/mathieurousse",
      "https://github.com/m-rousse"
    ]
  }
  </script>
  <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/datadog-rum-v4.js','DD_RUM')
    DD_RUM.onReady(function() {
      DD_RUM.init({
        clientToken: 'pub5e022b5673a75a3e62659ed01005bfb2',
        applicationId: 'c5f01a98-9117-42ce-8ca1-35cb8fac73a5',
        site: 'datadoghq.com',
        service:'personal-blog',
        env:'prod',
        // Specify a version number to identify the deployed version of your application in Datadog
        // version: '1.0.0',
        sampleRate: 100,
        trackInteractions: true,
        defaultPrivacyLevel: 'mask-user-input'
      });

      DD_RUM.startSessionReplayRecording();
    })
  </script>
</head>


  <body>

    <div class="container">

      <div class="header clearfix">

  <nav class="navbar navbar-light bg-faded" itemscope itemtype="http://schema.org/SiteNavigationElement">
    <a class="navbar-brand" href="/">Last code until midnight</a>
    <ul class="nav navbar-nav pull-right">
      <li class="nav-item"><a class="nav-link" itemprop="url" href="/"><span itemprop="name">Home</span></a></li>
      <li class="nav-item"><a class="nav-link" itemprop="url" href="/projects/"><span itemprop="name">Projects</span></a></li>
      <li class="nav-item"><a class="nav-link" itemprop="url" href="/about/"><span itemprop="name">About</span></a></li>
    </ul>
  </nav>
</div>


      <div class="container">
  <h1 class="title">Removing marketing links in e-mails with Sieve</h1>

  <p class="title-date"><small class="text-muted">May 22, 2017</small></p>

  <p>E-mail marketing companies track the link opened in the e-mails to offer a better vision of what worked and what did not to the client. The tracking method consist to rewrite every links in the e-mail with links to a server of the marketing company which then redirects the customer to the right page.</p>

<p>This leads to having some weird and unintellegible links in the e-mails we receive every day, like so :</p>

<!---excerpt-break-->

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://xxxx.srvn.list-manage1.com/track/click?u=yyyyyyyy&amp;id=zzzzzzzz&amp;e=ppppppppp
</code></pre></div></div>

<p>This bothers me as I do not know where I will be redirected. So I used Sieve and python to rewrite the links back.</p>

<p><a href="http://sieve.info/">Sieve</a> is a language to filter e-mail messages. It can take several actions as classifying e-mails or sending them to third party programs. In this case it will allow us to filter the e-mails and depending on the sending address, rewrite the links or not.</p>

<p>My global sieve config file contains :</p>

<div><pre class="language-bash line-numbers">
<code class="language-bash">plugin {
    ...
    sieve_plugins = sieve_extprograms
    sieve_filter_bin_dir = /folder/to/sieve/scripts
    sieve_extensions = +vnd.dovecot.filter
    sieve_filter_exec_timeout = 60s
    ...
}</code></pre></div>

<p>My local sieve config file looks like this :</p>

<div><pre class="language-bash line-numbers">
<code class="language-bash">require ["copy","fileinto","imap4flags", "vnd.dovecot.filter"];
# rule:[Marketing URL]
if header :contains "from" "marketing@campain.thx"
{
    filter "filter.py";
}</code></pre></div>

<p>Then we need to create the python script at : <code class="language-plaintext highlighter-rouge">/folder/to/sieve/scripts/filter.py</code>. It reads the e-mail in MIME format from <code class="language-plaintext highlighter-rouge">stdin</code>, then parses for URLs. I chose the regex to catch links to other sites, link to the 1px image that indicates that I read the e-mail and link to unsuscribe (as I do not want my script to unsuscribe by mistake).</p>

<p>For each link to another website, it does a request and retrieves the <code class="language-plaintext highlighter-rouge">Location</code> header and replaces the link with this new URL. For the other links, it replaces them with a link to Google.</p>

<script src="https://gist.github.com/m-rousse/89a4128edaa52d6e227221d47e017d1e.js"> </script>

<p>The last thing to note is that the e-mail should be sent back to <code class="language-plaintext highlighter-rouge">stdout</code> in MIME format.</p>

<p>Enjoy your e-mails with comprehensible links :)</p>


</div>


      <hr>

      <div class="container">

  <div class="row">

    <div class="col-md-6">
      <ul class="list-unstyled">
        <li><a id="contactAdd"><i class="fa fa-envelope-o fa-fw"></i> mathieu at rousse d0t me</a></li>
        <li><a href="/feed.xml"><i class="fa fa-rss fa-fw"></i>RSS</a></li>
      </ul>
    </div>

    <div class="col-md-6">
      <div class="footer-col footer-col-2">
        <ul class="list-unstyled">
          
          <li>
            <a href="https://github.com/m-rousse"><i class="fa fa-github fa-fw"></i><span class="username">m-rousse</span></a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/roussemath"><i class="fa fa-twit-icon fa-fw"></i><span class="username">roussemath</span></a>
          </li>
          

          
          <li>
            <a href="https://fr.linkedin.com/in/mathieurousse"><i class="fa fa-lin fa-fw"></i><span class="username">mathieurousse</span></a>
          </li>
          
        </ul>
      </div>

    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <p class="text-muted">The blog of an IT and security enthusiast.</p>
    </div>
  </div>
</div>
<script type="text/javascript" src="/js/LastLineUntilMidnight.min.js"></script>

    </div>

  </body>

</html>
