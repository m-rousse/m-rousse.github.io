<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Dynamic DNS with docker</title>
  <meta name="description" content="Dynamically update DNS zone to give domain name to new Dockers.">
  <meta name="keywords" content="blog, Mathieu Rousse, linux, pentest, challenge, ctf, writeup">
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,300,500,600&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/main.min.css">
  <link rel="canonical" href="https://math.rousse.me/sysadmin/2017/05/22/docker-ddns.html">
  <link rel="alternate" type="application/rss+xml" title="Last code until midnight" href="https://math.rousse.me/feed.xml">
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "Mathieu Rousse",
    "url": "https://math.rousse.me",
    "sameAs": [
      "https://fr.linkedin.com/in/mathieurousse",
      "https://github.com/m-rousse"
    ]
  }
  </script>
  <script>
    (function(h,o,u,n,d) {
      h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
      d=o.createElement(u);d.async=1;d.src=n
      n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
    })(window,document,'script','https://www.datadoghq-browser-agent.com/datadog-rum-v4.js','DD_RUM')
    DD_RUM.onReady(function() {
      DD_RUM.init({
        clientToken: 'pub5e022b5673a75a3e62659ed01005bfb2',
        applicationId: 'c5f01a98-9117-42ce-8ca1-35cb8fac73a5',
        site: 'datadoghq.com',
        service:'personal-blog',
        env:'prod',
        // Specify a version number to identify the deployed version of your application in Datadog
        // version: '1.0.0',
        sampleRate: 100,
        trackInteractions: true,
        defaultPrivacyLevel: 'mask-user-input'
      });

      DD_RUM.startSessionReplayRecording();
    })
  </script>
</head>


  <body>

    <div class="container">

      <div class="header clearfix">

  <nav class="navbar navbar-light bg-faded" itemscope itemtype="http://schema.org/SiteNavigationElement">
    <a class="navbar-brand" href="/">Last code until midnight</a>
    <ul class="nav navbar-nav pull-right">
      <li class="nav-item"><a class="nav-link" itemprop="url" href="/"><span itemprop="name">Home</span></a></li>
      <li class="nav-item"><a class="nav-link" itemprop="url" href="/projects/"><span itemprop="name">Projects</span></a></li>
      <li class="nav-item"><a class="nav-link" itemprop="url" href="/about/"><span itemprop="name">About</span></a></li>
    </ul>
  </nav>
</div>


      <div class="container">
  <h1 class="title">Dynamic DNS with docker</h1>

  <p class="title-date"><small class="text-muted">May 22, 2017</small></p>

  <p>Iâ€™ve been fiddling with dockers lately and have become a little lazy about the IP addresses of the containers. As lazy as the programmer that I am, I decided to configure DDNS with Bind.</p>

<p>This way, I could simply reach out <code class="language-plaintext highlighter-rouge">container.sea</code> instead of <code class="language-plaintext highlighter-rouge">172.17.0.22</code>.</p>

<!---excerpt-break-->

<p>To make it work I used the <a href="https://docker-py.readthedocs.io/en/stable/">docker Python bindings</a>. The script listens to events and when a container is started, it adds its address to the DNS server using the <code class="language-plaintext highlighter-rouge">dnspython</code> module.</p>

<p>First thing first, we need to install the docker and dns python modules :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install docker dnspython
</code></pre></div></div>

<p>Then we can listen on docker events using this snippet :</p>

<div><pre class="language-python line-numbers">
<code class="language-python">import docker
client = docker.DockerClient(base_url='unix://var/run/docker.sock')
for event in client.events():
    print(event)</code></pre></div>

<p>If you start/stop a container you should see events appear !</p>

<p>To dynamically update a DNS zone, you have to configure Bind to allow DDNS, Julien Valroff wrote a good article about this on <a href="https://www.kirya.net/articles/running-a-secure-ddns-service-with-bind/">his blog</a>.</p>

<p>Then you can use this snippet to update a zone :</p>

<div><pre class="language-python line-numbers">
<code class="language-python">import dns.query
import dns.tsigkeyring
import dns.update
import sys

keyring = dns.tsigkeyring.from_text({
    'sea.' : 'XXXXXXXXXXXXXXXXXXXXXX=='
})

update = dns.update.Update('container.sea', keyring=keyring)
update.replace('container', 300, 'a', "172.17.0.22")

response = dns.query.tcp(update, '10.0.0.1')</code></pre></div>

<p>With this code, I put together this little script that creates my domain names as I start/stop my containers : [As a little bonus, I added the systemd service file :)]</p>

<script src="https://gist.github.com/m-rousse/b98363fd3370e33a253d11a64e4de92a.js"> </script>

<p>Feel free to contact me if you want any more explanations or have a suggestion :)</p>


</div>


      <hr>

      <div class="container">

  <div class="row">

    <div class="col-md-6">
      <ul class="list-unstyled">
        <li><a id="contactAdd"><i class="fa fa-envelope-o fa-fw"></i> mathieu at rousse d0t me</a></li>
        <li><a href="/feed.xml"><i class="fa fa-rss fa-fw"></i>RSS</a></li>
      </ul>
    </div>

    <div class="col-md-6">
      <div class="footer-col footer-col-2">
        <ul class="list-unstyled">
          
          <li>
            <a href="https://github.com/m-rousse"><i class="fa fa-github fa-fw"></i><span class="username">m-rousse</span></a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/roussemath"><i class="fa fa-twit-icon fa-fw"></i><span class="username">roussemath</span></a>
          </li>
          

          
          <li>
            <a href="https://fr.linkedin.com/in/mathieurousse"><i class="fa fa-lin fa-fw"></i><span class="username">mathieurousse</span></a>
          </li>
          
        </ul>
      </div>

    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <p class="text-muted">The blog of an IT and security enthusiast.</p>
    </div>
  </div>
</div>
<script type="text/javascript" src="/js/LastLineUntilMidnight.min.js"></script>

    </div>

  </body>

</html>
